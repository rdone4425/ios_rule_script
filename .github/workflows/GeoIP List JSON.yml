name: Generate GeoIP List JSON

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC 00:00运行
  workflow_dispatch:      # 允许手动触发
  
jobs:
  generate-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create directories and generate JSON
        run: |
          # 创建目录
          mkdir -p main/geoip
          
          # 开始生成JSON内容
          echo "{" > main/geoip/geoip_list.json
          echo "  \"元数据\": {" >> main/geoip/geoip_list.json
          echo "    \"更新时间\": \"$(date -u '+%Y-%m-%d %H:%M:%S UTC')\"," >> main/geoip/geoip_list.json
          echo "    \"来源\": \"rdone4425/meta-rules-dat\"" >> main/geoip/geoip_list.json
          echo "  }," >> main/geoip/geoip_list.json
          echo "  \"国家\": [" >> main/geoip/geoip_list.json
          
          # 获取并处理所有.list文件
          FIRST=true
          LIST_FILES=$(curl -s https://api.github.com/repos/rdone4425/meta-rules-dat/contents/geo/geoip | jq -r '.[] | select(.name | endswith(".list")) | .name')
          
          echo "$LIST_FILES" | while read -r file; do
            if [ -n "$file" ]; then
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                echo "    ," >> main/geoip/geoip_list.json
              fi
              country="${file%.list}"
              echo "    {" >> main/geoip/geoip_list.json
              echo "      \"代码\": \"${country}\"," >> main/geoip/geoip_list.json
              echo "      \"文件\": \"${file}\"," >> main/geoip/geoip_list.json
              echo "      \"链接\": \"https://raw.githubusercontent.com/rdone4425/meta-rules-dat/meta/geo/geoip/${file}\"" >> main/geoip/geoip_list.json
              echo -n "    }" >> main/geoip/geoip_list.json
            fi
          done
          
          # 完成JSON结构
          echo "" >> main/geoip/geoip_list.json
          echo "  ]" >> main/geoip/geoip_list.json
          echo "}" >> main/geoip/geoip_list.json
          
          # 安装jq（如果需要）
          sudo apt-get update && sudo apt-get install -y jq
          
          # 使用jq格式化JSON并验证
          if ! jq '.' main/geoip/geoip_list.json > main/geoip/temp.json; then
            echo "JSON格式验证失败"
            exit 1
          fi
          mv main/geoip/temp.json main/geoip/geoip_list.json
          
          # 显示生成的文件内容
          cat main/geoip/geoip_list.json
          
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add main/geoip/geoip_list.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "更新 GeoIP 列表 JSON" && git push) 
