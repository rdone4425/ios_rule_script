name: Generate GeoIP List JSON

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC 00:00运行
  workflow_dispatch:      # 允许手动触发
  
jobs:
  generate-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
        
      - name: Create directories and generate JSON
        run: |
          # 创建目录
          mkdir -p main/geoip
          
          # 定义基础URL
          BASE_URL="https://github.com/rdone4425/meta-rules-dat/tree/meta/geo/geoip"
          RAW_BASE_URL="https://raw.githubusercontent.com/rdone4425/meta-rules-dat/meta/geo/geoip"
          
          # 开始生成JSON内容
          echo "{" > main/geoip/geoip_list.json
          echo "  \"元数据\": {" >> main/geoip/geoip_list.json
          echo "    \"更新时间\": \"$(date -u '+%Y-%m-%d %H:%M:%S UTC')\"," >> main/geoip/geoip_list.json
          echo "    \"来源\": \"${BASE_URL}\"" >> main/geoip/geoip_list.json
          echo "  }," >> main/geoip/geoip_list.json
          echo "  \"国家\": [" >> main/geoip/geoip_list.json
          
          # 获取页面内容并提取.list文件
          FIRST=true
          curl -s "${BASE_URL}" | grep -o 'title="[^"]*\.list"' | cut -d'"' -f2 | sort | while read -r file; do
            if [ -n "$file" ]; then
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                echo "    ," >> main/geoip/geoip_list.json
              fi
              
              country="${file%.list}"
              echo "    {" >> main/geoip/geoip_list.json
              echo "      \"代码\": \"${country}\"," >> main/geoip/geoip_list.json
              echo "      \"文件\": \"${file}\"," >> main/geoip/geoip_list.json
              echo "      \"链接\": \"${RAW_BASE_URL}/${file}\"" >> main/geoip/geoip_list.json
              echo -n "    }" >> main/geoip/geoip_list.json
            fi
          done
          
          # 完成JSON结构
          echo "" >> main/geoip/geoip_list.json
          echo "  ]" >> main/geoip/geoip_list.json
          echo "}" >> main/geoip/geoip_list.json
          
          # 格式化最终的JSON
          jq '.' main/geoip/geoip_list.json > main/geoip/temp.json && mv main/geoip/temp.json main/geoip/geoip_list.json
          
          # 显示生成的内容
          echo "生成的JSON内容："
          cat main/geoip/geoip_list.json
          
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add main/geoip/geoip_list.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "更新 GeoIP 列表 JSON" && git push) 
